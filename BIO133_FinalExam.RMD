---
title: "BIO133 Final Exam"
output:
  word_document: default
---

**Lecturer:** Dr. Leone Brown
**Lab TA:** Natalie Kerr  
**Name:** Hannah Yin 
**Date due:** 2019-05-09

<br> 

## BIO133 Ecological Models and Data - Final Exam

This is a take-home exam. You may consult with your classmates and friends IF you are working on different butterfly species. You should make your own conclusions and state them in your own words.  I encourage each student to choose a different butterfly species.  

The data you are using were collected by the Massachusetts Butterfly (MBC)[http://www.naba.org/chapters/nabambc/], a group that organizes trips to see butterflies around the state, and also maintains records of butterflies seen by club members. These data were shared with the Crone lab at Tufts for analysis, resulting in both recent and forthcoming publications (e.g., see Breed et al. 2013 in the Final folder on Canvas). You will be using a portion of the data collected by MBC for this exam, specifically, species lists from 1992-2010. We are very grateful to the Massachusetts Butterfly Club for keeping such careful records and sharing them with the Crone lab. If you are in the area this summer, and interested in butterflies, you can join one of their trips: https://www.naba.org/chapters/nabambc/downloads/2019%20MBC%20Field%20Trips.pdf  

Long-term data like these have become of great interest in the context of understanding how species are responding to changing climate conditions. We know that there are two broad patterns in these data: 

1. Most species are being seen earlier in the year now than they were in the past, probably because insect development is faster in warmer temperatures, and, on average, the climate is becoming warmer.   
2. Species near their southern range limits tend to be declining in relative abundance, and species near their northern range limits tend to be increasing in abundance.  Presumably, this reflects species shifting their ranges to match changing climate conditions.  

However, not all species conform to these patterns. Your job is to choose one species, and evaluate whether it is increasing or declining in abundance, and whether it is being seen earlier or later in the year through time.  You will also analyze whether year-to-year variation in the dates on which butterflies are seen is associated with how warm the spring was in each year.  

<br> 

## Some tips for using this RMarkdown template

1. If the question asks you to report statistics or coefficients, you need to report the **exact** statistics without other unnecessary info. For example, coef(model) is preferred over summary(model) if we asked for coefficients. In other words, please **only** include what the question asks.

2. Along those lines, please avoid including unnecessary things. For example, if you want to show some of your data. Please use head(data) and not ALL the data. 

3. If you want to exclude a code chunk from the final output, please enter "eval = F, include = F" code into the heading. Eval = F means it will not run the code and include = F means it will not include it in the knitted document. 

```{r EXAMPLE, eval = F, include = F }

```

4. Please "knit" the document to word. If you do not know how to do this, please email Natalie. 

<br> 

## Libraries

```{r Enter libraries here, message = F, include = F }
library(lme4)
library(car)
library(bbmle)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br>

## PART 1 - Data selection and cleaning.

A. Choose a butterfly species to work with. The folder butterfly club data includes 100 .csv files, each giving information for a different species.  The species are identified by 4-letter codes, which are identified by name in the butterfly species codes spreadsheet. You can see photos of the butterflies on the MBC website, and also read accounts of many of them written by MBC member Sharon Stichter: https://www.butterfliesofmassachusetts.net/.  

State which butterfly species you are going to analyze, and briefly (1-2 sentences) explain why.  [because I thought it was pretty is a perfectly acceptable explanation]  


I am curious how changing climate conditions may affect this pretty butterfly commonly spotted in Massachusetts.


<br> 

B. Each data file has~20,000 rows and 6 columns.  Each row is a trips recorded in the MCB database. The columns are: (1) listlength is the number of species seen on a particular trip; (2) present is a column coding whether that species was seen on each trip (1 = species seen, 0 = species not seen); (3) listyear is the year of the trip; (4) yearday is the day of year on which each trip took place, e.g., Jan 1 is day 1, April 1 is day 91, June 1 is day 152, etc. (5) listplace identified the Massachusetts township in which each trip took place; (6) ltqty is the number of individual butterflies of that species seen on that trip.  In order to do the analyses, you will need to clean the data in three ways:

*	For some reason, the present column occasionally includes values greater than 1.  For your analysis, you should replace all values > 1 with a 1.

*	The database includes some records from years before the club started making regular trips.  For this analysis, filter the data to include only records collected between 1992 and 2010.

*	The database also includes some records where individual club members reported single interesting butterfly species, without really searching an area.  To remove these records, filter your data to include only trips where the listlength is greater than 5 species.

```{r 1B }
ETBL <- read.csv("D:/Docs/College/Sophomore/BIO133_data/ETBLlist.csv", header = TRUE)
ETBL$present[ETBL$present >= 1] <- 1
ETBL <- ETBL[203:19999, ] # 1992 - 2010
ETBL <- ETBL[ETBL$listlength > 5, ]
```  

<br>

C. In order to analyze whether temperature affects butterfly phenology (i.e., the days on which a species is present), we need to merge the data on sightings of your butterfly with temperature data. Temperature is summarized for each year using cumulative growing degree days (GDD) from the beginning of the year until June 1.  (See https://en.wikipedia.org/wiki/Growing_degree-day or the Hodgson et al. 2010  and Cayton et al. 2015 papers online for an extended description of the relationship between GDD and temperature in general, and applied to butterfly phenology in particular.)  

*	Use R to merge the Jan-Jun GDD for each species with the butterfly sightings data for your species. You can ask for help with this step during office hours or in class on April 25th; it is may be slightly beyond the data management we covered in lab so far.  

```{r 1C }
GDD <- read.csv("D:/Docs/College/Sophomore/BIO133_data/GDD_MA.csv", header = TRUE)
GDD_match <- GDD[3:21, ]
ETBL_analysis <- merge(ETBL, GDD_match, by.x = "listyear", by.y = "ï..year", all = TRUE)
str(ETBL_analysis)
```


<br> 


## PART 2 - Analysis of trends, using data on whether species were present on lists

A.  This analysis will be based on the "present" column in the dataframe.  Select an appropriate probability distribution for the "present" column.  Briefly justify your choice.

The binomial distribution because the result is binary: you either see or don't see the species.

<br>

B. Test whether the probability your species is seen on lists is changing through time using a simple GLM with the probability distribution chosen in part 2A, and listyear as a continuous predictor variable.  Report the line(s) of code used in your analysis, the R output of your code, and the test statistics used to reach your conclusion.  Be sure to report both whether the species is increasing or decreasing and whether this change is statistically significant.  

```{r 2B }
m_binyear1 <- glm(present ~ scale(listyear), family = binomial, data = ETBL_analysis)
(plogis(coef(m_binyear1)[2])) # slope coefficient for listyear, a linear trend and > 0
Anova(m_binyear1)
# The probability of seeing Eastern Tailed Blue on lists is increasing but this change is not statistically significant (Chi-squared value = 1.544, df = 1, p = 0.2826).
```

<br>

C. Repeat the analysis in part 2B using a mixed-effects GLMM with a random effect of year. Report the same statistics as in part 2B plus an estimate of the among-year standard deviation.  

```{r 2C }
m_binyear2 <- glmer(present ~ scale(listyear) + (1 | listyear), family = binomial, data = ETBL_analysis)
(plogis(fixef(m_binyear2)[2])) # slope coefficient for listyear, a linear trend and > 0
Anova(m_binyear2)
# The probability of seeing Eastern Tailed Blue on lists is increasing but this change is not statistically significant (Chi-squared value = 0.4461, df = 1, p = 0.5042).

# back-transformed estimate of among-year standard deviation
(plogis(getME(m_binyear2, "theta"))) 
```  

<br> 

D. Repeat the analysis in part 2B using a mixed-effects GLMM with a random effect of township (listplace).  Report the same statistics as in part 2B plus an estimate of the among-site standard deviation.  

```{r 2D }
m_binyear3 <- glmer(present ~ scale(listyear) + (1 | listplace), family = binomial, data = ETBL_analysis)
(plogis(fixef(m_binyear3)[2])) # slope coefficient for listyear, a linear trend and > 0
Anova(m_binyear3)
# The probability of seeing Eastern Tailed Blue on lists is increasing but this change is not statistically significant (Chi-squared value = 0.0428, df = 1, p = 0.8361).

# back-transformed estimate of among-site standard deviation
(plogis(getME(m_binyear3, "theta"))) 
```

<br>

E. For your species, is variation larger among sites or among years?  Briefly, explain your answer (i.e., say "years because..."", not just "years")    

```{r 2E }
# Sites because the standard deviation of the random effect of listplace is greater than that of listyear.
```  

<br>

F. In Breed et.'s 2013 analysis of these data, they included the number of species seen on each trip as a second covariate of species presence.  The idea here is that the number of species seen overall acts as a measure of how good the conditions were on each day (butterflies like warm sunny weather) and how carefully the participants looked on each trip.  Repeat the analysis in part 2B adding listlength as a second fixed effect (i.e., a second predictor variable). Report the same statistics as in part 2B plus the slope coefficient for list length.  

```{r 2F }
m_yearsp <- glm(present ~ scale(listyear) + scale(listlength), family = binomial, data = ETBL_analysis)
(plogis(coef(m_yearsp)[2])) # slope coefficient for listyear, a linear trend and > 0
Anova(m_yearsp)
# The probability of seeing Eastern Tailed Blue on lists is increasing and this change is statistically significant after accounting for the number of species seen on each trip (Chi-squared value = 7.93, df = 1, p = 0.004874).
(plogis(coef(m_yearsp)[3])) # slope coefficient for listlength, a linear trend and > 0
```

<br>

2G. Which of the four models fit above is best for these data?  Justify your answer using statistics.  
```{r 2G}
ICtab(m_binyear1, m_binyear2, m_binyear3, m_yearsp, base = TRUE)
# The model using a simple binomial GLM with listyear and listlength as predictor variables best fit these data because it has the lowest AIC.
```


<br> 

H. Of course, it is possible to include any combination of the two random effects and list length.  Which set do you think is best for your data?  Briefly, justify your choice.  Run this model.  Show the R code you used, and report the relevant output (i.e., the coefficients and test statistics).


```{r 2H }
m0 <- glm(present ~ 1, family = binomial, data = ETBL_analysis)
m1 <- glmer(present ~ 1 + (1 | listyear), family = binomial, data = ETBL_analysis)
m2 <- glmer(present ~ 1 + (1 | listplace), family = binomial, data = ETBL_analysis)
m3 <- glmer(present ~ 1 + (1 | listyear) + (1 | listplace), family = binomial, data = ETBL_analysis)
ICtab(m0, m1, m2, m3, base = TRUE)

m_sp1 <- glm(present ~ scale(listlength), family = binomial, data = ETBL_analysis)
m_sp2 <- glmer(present ~ scale(listlength) + (1 | listyear), family = binomial, data = ETBL_analysis)
m_sp3 <- glmer(present ~ scale(listlength) + (1 | listplace), family = binomial, data = ETBL_analysis)
m_sp4 <- glmer(present ~ scale(listlength) + (1 | listyear) + (1 | listplace), family = binomial, data = ETBL_analysis)
ICtab(m_sp1, m_sp2, m_sp3, m_sp4, base = TRUE) # test statistics
(plogis(fixef(m_sp4))) # coefficients
Anova(m_sp4) # test statistics
# The model with listlength as a fixed effect and listyear and listplace as random effects is the best combination of the two random effects and list length because it has the lowest AIC. It makes sense that butterfly presence would have both environmental and spatial stochasticity (year and township respectively), and test statistics in question 2F showed that having the number of species seen on each trip as a fixed effect significantly improved model fit to the data. Note that this model is also better than the best model from question 2G.
```

<br> 

## PART 3 - Analysis of the number of individuals seen on each trip.

A. For this analysis, you will use the ltqty column of the data, i.e., the number of individuals of your species seen on each trip.  Choose and briefly justify a probability distribution for these data.

I will use a Poisson distribution because it applies to count data.

<br>

B. Analyze trends in abundance of your species through time using ltqty as the response variable and year as a continuous predictor variable.  Report the lines of code used to run your analysis, the slope coefficient(s) for the effect of year, and relevant test statistics for deciding whether the abundance is changing through time.

```{r 3B }
m_count1 <- glm(ltqty ~ 1, family = poisson, data = ETBL_analysis)
m_count2 <- glm(ltqty ~ scale(listyear), family = poisson, data = ETBL_analysis)
(exp(coef(m_count2)[2])) # slope coefficient for the effect of year, < 1
anova(m_count1, m_count2, test = "Chisq")

# Species abundance as documented by the MA Butterfly Club appears to be changing through time. The decrease in abundance is significant (Chi-squared value = 64.626, df = 1, p = 9.057e-16) compared to it year is not accounted for.
```

<br>

C. Both species presence and the number seen are metrics of abundance.  Did you reach the same conclusion by analyzing presence as number seen?  If not, which analysis do you think gives a better answer?  Decide whether your species is significantly increasing, significantly decreasing or not changing in abundance, and briefly explain how your statistical models relate to your conclusion.

No, I did not reach the same conclusion. I think the analysis with the presence seen gives a better answer because the analysis with number seen was not as extensive in terms of the number of predictor variables considered and the types of distributions that incorporate the Poisson distribution. Therefore, based on the analysis with presence seen, the Eastern Tailed Blue is increasing in abundance: the best model from this analysis uses a linear trend, and its slope coefficient is positive (~0.737) and significant (Chi-square value = 598.76, df = 1, p < 2.2e-16).

<br>

## PART 4 - Analysis of phenology (sighting dates)

A. For this analysis, you will use only trips on which the species was seen.  Create a new data frame by filtering your data to include only trips with present = 1.  Report the line of code used to create this new data frame, and the number of trips on which your species was seen (i.e., the number of rows in your data frame).  

```{r 4A }
ETBL_present <- ETBL_analysis[ETBL_analysis$present == 1, ]
(nrow(ETBL_present)) # number of trips on which the Eastern Tailed Blue was seen
```

<br>

B. Choose a probability distribution for sighting dates, i.e., the yearday column.  Briefly, justify your choice.  

Sighting dates follow the normal distribution by process of elimination of the main probability distributions presented in R for this class. Sighting dates are neither binary nor counts. 

<br> 

C. Test whether the average sighting date is changing through time using a GLM with the probability distribution chosen above, and listyear as a continuous predictor variable. Report the line(s) of code used in your analysis, the R output of your code, and the test statistics used to reach your conclusion. Be sure to report both whether the average date is increasing (later phenology) or decreasing (earlier phenology) and whether this change is statistically significant.  

```{r 4C }
m_normyear <- glm(yearday ~ scale(listyear), family = gaussian, data = ETBL_present)
(coef(m_normyear)[2])
Anova(m_normyear)
# The average date is significantly decreasing (Chi-squared value = 11.082, df = 1, p = 0.0008718).
```

<br> 

D. Test whether the average sighting date depends on spring temperatures using a GLM with the probability distribution chosen above, and GDD as a continuous predictor variable.  Report the line(s) of code used in your analysis, the R output of your code, and the test statistics used to reach your conclusion.  Be sure to report both whether the average date is higher (later phenology) or lower (earlier phenology) in years with higher GDD, and whether this change is statistically significant.    

```{r 4D }
m_GDD <- glm(yearday ~ scale(GDD_JanJun), family = gaussian, data = ETBL_present)
(coef(m_GDD)[2])
Anova(m_GDD)
# The average sighting date is lower in years with higher GDD, and this change is statistically significant (Chi-squared value = 6.0161, df = 1, p = 0.01418).
```

<br> 

E. Not surprisingly, the climate is generally getting warmer through time. Is variation in GDD sufficient to explain trends in phenology, or is something more going on?  To evaluate this possibility, fit a GLM to the yearday data, using both year and GDD as continuous predictor variables.  If year is still statistically significant even after accounting for GDD in each year, there may be something more going on.  Report the lines of R code you used to run this model, the relevant test statistics, and your conclusions.    

```{r 4E }
m_yearGDD <- glm(yearday ~ scale(listyear) + scale(GDD_JanJun), family = gaussian, data = ETBL_present)
Anova(m_yearGDD)
# Year is still statistically significant even after accounting for GDD in each year: adding listyear to the model just accounting for GDD in each year significantly changed the model (Chi-square value = 7.1052, df = 1, p = 0.007687). Something more is probably going on.
```

<br> 


## PART 5 - Conclusions

Briefly, summarize what you have learned about your butterfly species from these analyses. You can include 1-2 sentences about the basic biology if you like. Be sure to include 2-4 sentences about your conclusions based on the statistical models.  

These analyses suggest that the Eastern Tailed Blue conforms to the two broad patterns in data collected by the Massachusetts Butterfly Club.
Reflecting the first pattern, this species is being seen earlier in the year than in the past (Chi-squared value = 11.082, df = 1, p = 0.0008718). However, not all of these earlier sightings are tied to higher GDD earlier in the year (Chi-square value = 7.1052, df = 1, p = 0.007687). The hypothesis on why species are being seen earlier does not fully explain why the Eastern Tailed Blue is being seen earlier in the year; the Eastern Tailed Blue is not developping faster just due to higher GDD.
Regarding the second pattern, MA is in the Eastern Tailed Blue's northern range, and its abundance appears to be increasing based on the analysis with presence (Chi-squared value = 598.76, df = 1, p < 2.2e-16). Perhaps the species is shifting its range north to adjust to the changing climate.

<br> 
